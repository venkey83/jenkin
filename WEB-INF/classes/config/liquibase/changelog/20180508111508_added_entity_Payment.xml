<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <property name="now" value="now()" dbms="mysql,h2"/>
    <property name="now" value="current_timestamp" dbms="postgresql"/>
    <property name="now" value="sysdate" dbms="oracle"/>

    <property name="autoIncrement" value="true" dbms="mysql,h2,postgresql,oracle"/>

    <property name="floatType" value="float4" dbms="postgresql, h2"/>
    <property name="floatType" value="float" dbms="mysql, oracle"/>

    <!--
        Added the entity Payment.
    -->
    <changeSet id="20180508111508-1" author="jhipster">
        <createTable tableName="payment">
            <column name="id" type="bigint" autoIncrement="${autoIncrement}">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="payment_model" type="varchar(25)">
                <constraints nullable="false"/>
            </column>

            <column name="payment_approval_id" type="bigint">
                <constraints nullable="true"/>
            </column>

            <column name="reference_no" type="varchar(255)">
                <constraints nullable="true"/>
            </column>

            <column name="bsf_reference_no" type="varchar(255)">
                <constraints nullable="true"/>
            </column>

            <column name="payment_method" type="varchar(25)">
                <constraints nullable="false"/>
            </column>

            <column name="token" type="bigint">
                <constraints nullable="true"/>
            </column>

            <column name="transaction_type" type="varchar(25)">
                <constraints nullable="false"/>
            </column>

            <column name="receipt_no" type="varchar(255)">
                <constraints nullable="true"/>
            </column>

            <column name="buyer_id" type="bigint">
                <constraints nullable="false"/>
            </column>

            <column name="buyer_user_id" type="bigint">
                <constraints nullable="false"/>
            </column>

            <column name="brand_id" type="bigint">
                <constraints nullable="true"/>
            </column>

            <column name="buyer_business_id" type="bigint">
                <constraints nullable="false"/>
            </column>

            <column name="payment_attempt" type="smallint">
                <constraints nullable="true"/>
            </column>

            <column name="invoice_list" type="json">
                <constraints nullable="false"/>
            </column>

            <column name="currency_id" type="varchar(5)">
                <constraints nullable="false"/>
            </column>

            <column name="currency_conversion_id" type="varchar(5)">
                <constraints nullable="true"/>
            </column>

            <column name="currency_conversion_rate" type="${floatType}">
                <constraints nullable="true"/>
            </column>

            <column name="business_service_fee" type="double">
                <constraints nullable="true"/>
            </column>

            <column name="business_service_fee_gst" type="double">
                <constraints nullable="true"/>
            </column>

            <column name="early_payment_discount" type="double">
                <constraints nullable="true"/>
            </column>

            <column name="grand_total" type="double">
                <constraints nullable="false"/>
            </column>

            <column name="grand_total_conversion_amount" type="double">
                <constraints nullable="true"/>
            </column>

            <column name="remittance_amount" type="double">
                <constraints nullable="false"/>
            </column>

            <column name="beneficiary_name" type="varchar(50)">
                <constraints nullable="true"/>
            </column>

            <column name="beneficiary_info" type="varchar(50)">
                <constraints nullable="true"/>
            </column>

            <column name="mpgs_response_code" type="int">
                <constraints nullable="true"/>
            </column>

            <column name="mpgs_response_message" type="varchar(25)">
                <constraints nullable="true"/>
            </column>

            <column name="payment_status" type="varchar(25)">
                <constraints nullable="false"/>
            </column>

            <column name="supplier_recon_status" type="varchar(25)">
                <constraints nullable="true"/>
            </column>

            <column name="create_datetime" type="timestamp">
                <constraints nullable="false"/>
            </column>

            <column name="update_datetime" type="timestamp">
                <constraints nullable="false"/>
            </column>

            <column name="deleted" type="bit">
                <constraints nullable="true" />
            </column>

            <column name="supplier_virtual" type="bigint"
                    defaultValueComputed="GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.supplierId', '&quot;',''), '[', ''),']', ''))">
                <constraints nullable="false" />
            </column>

            <column name="invoice_virtual" type="varchar(25)"
                    defaultValueComputed="GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.invoiceNumber', '&quot;',''), '[', ''),']', ''))">
                <constraints nullable="false" />
            </column>

            <column name="po_virtual" type="varchar(25)"
                    defaultValueComputed="GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.poNumber', '&quot;',''), '[', ''),']', ''))">
                <constraints nullable="false" />
            </column>

        </createTable>

        <dropDefaultValue tableName="payment" columnName="create_datetime" columnDataType="datetime"/>

        <modifySql>
            <replace replace="supplier_virtual BIGINT DEFAULT GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.supplierId', '&quot;',''), '[', ''),']', '')) NOT NULL"
                     with="supplier_virtual BIGINT GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.supplierId', '&quot;',''), '[', ''),']', '')) NOT NULL"/>
        </modifySql>

        <modifySql>
            <replace replace="invoice_virtual VARCHAR(25) DEFAULT GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.invoiceNumber', '&quot;',''), '[', ''),']', '')) NOT NULL"
                     with="invoice_virtual VARCHAR(25) GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.invoiceNumber', '&quot;',''), '[', ''),']', '')) NOT NULL"/>
        </modifySql>

        <modifySql>
            <replace replace="po_virtual VARCHAR(25) DEFAULT GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.poNumber', '&quot;',''), '[', ''),']', '')) NOT NULL"
                     with="po_virtual VARCHAR(25) GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.poNumber', '&quot;',''), '[', ''),']', '')) NOT NULL"/>
        </modifySql>

    </changeSet>

    <changeSet author="jhipster" id="20180508111508-2">
        <createIndex indexName="idx_supplier_virtual"
                     tableName="payment"
                     unique="false">
            <column name="supplier_virtual"/>
        </createIndex>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-3">
        <createIndex indexName="idx_invoice_virtual"
                     tableName="payment"
                     unique="false">
            <column name="invoice_virtual"/>
        </createIndex>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-4">
        <createIndex indexName="idx_po_virtual"
                     tableName="payment"
                     unique="false">
            <column name="po_virtual"/>
        </createIndex>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-5">
        <dropColumn columnName="beneficiary_name"
                    tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-6">
        <dropColumn columnName="beneficiary_info"
                    tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-7">
        <renameColumn columnDataType="bit"
                      newColumnName="tax_invoice"
                      oldColumnName="remittance_amount"
                      tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-8">
        <addColumn
            tableName="payment">
            <column beforeColumn="business_service_fee" afterColumn="currency_conversion_rate" name="invoice_total" type="double"/>
        </addColumn>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-9">
        <addColumn
            tableName="payment">
            <column beforeColumn="early_payment_discount" afterColumn="business_service_fee_gst" name="bsf_total" type="double"/>
        </addColumn>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-10">
        <modifyDataType
            columnName="tax_invoice"
            newDataType="double"
            tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-11">
        <modifyDataType
            columnName="payment_approval_id"
            newDataType="varchar(255)"
            tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-12">
        <dropColumn columnName="buyer_business_id"
                    tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-13">
        <dropColumn columnName="brand_id"
                    tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-14">
        <dropColumn columnName="tax_invoice"
                    tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-15">
        <dropColumn columnName="business_service_fee"
                    tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-16">
        <dropColumn columnName="business_service_fee_gst"
                    tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-17">
        <dropColumn columnName="bsf_total"
                    tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-18">
        <dropColumn columnName="early_payment_discount"
                    tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-19">
        <dropColumn columnName="invoice_total"
                    tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-20">
        <dropColumn columnName="grand_total"
                    tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-21">
        <dropColumn columnName="grand_total_conversion_amount"
                    tableName="payment"/>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-22">
        <addColumn
            tableName="payment">
            <column beforeColumn="reference_no" afterColumn="payment_approval_id" name="batch_payment_reference" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-23">
        <modifyDataType
            columnName="mpgs_response_code"
            newDataType="varchar(10)"
            tableName="payment"/>
    </changeSet>


    <changeSet author="jhipster" id="20180508111508-25">
        <dropNotNullConstraint columnDataType="timestamp"
                               columnName="update_datetime"
                               tableName="payment"/>
        <dropNotNullConstraint columnDataType="timestamp"
                               columnName="create_datetime"
                               tableName="payment"/>
    </changeSet>
    <changeSet author="jhipster" id="20180508111508-26">
        <renameColumn columnDataType="bigint"
                      newColumnName="token_repo_id"
                      oldColumnName="token"
                      tableName="payment"/>
    </changeSet>
   <changeSet author="jhipster" id="20180508111508-27">
        <addColumn
            tableName="payment">
            <column beforeColumn="payment_method" afterColumn="bsf_reference_no" name="admin_fee_reference_no" type="varchar(255)"/>
        </addColumn>
    </changeSet>

   <changeSet id="20180508111508-30" author="jhipster">
        <sql dbms="mysql">
            ALTER TABLE payment add remittanceadvice_virtual DOUBLE GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.remittanceAdvice', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment add adminfee_virtual DOUBLE GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.adminFee', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment add buyerbsffee_virtual DOUBLE GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.buyerBusinessServiceFee', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment add buyerbsfgst_virtual DOUBLE GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.buyerBusinessServiceFeeGst', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment add supplierbsffee_virtual DOUBLE GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.supplierBusinessServiceFee', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment add supplierbSfgst_virtual DOUBLE GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.supplierBusinessServiceFeeGst', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment add buyerbsftotal_virtual DOUBLE GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.buyerBsfTotal', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment add supplierbsftotal_virtual DOUBLE GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.supplierBsfTotal', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment add earlypaymentdiscount_virtual DOUBLE GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.earlyPaymentDiscount', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment add invoicegrandtotal_virtual DOUBLE GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.invoiceGrandTotal', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment add totalamountpayable_virtual DOUBLE GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.totalAmountPayable', '&quot;',''), '[', ''),']', ''));
           </sql>
    </changeSet>

    <changeSet author="jhipster" id="20180508111508-32">
        <addColumn
            tableName="payment">
            <column  name="giro_status" type="varchar(25)"/>
        </addColumn>
    </changeSet>

    <changeSet id="20180508111508-33" author="jhipster">
        <sql dbms="mysql">
        ALTER TABLE payment add brand_virtual  BIGINT GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.brandId', '&quot;',''), '[', ''),']', ''));
        </sql>
    </changeSet>

    <changeSet id="20180508111508-35" author="jhipster">
         <sql dbms="mysql">
        ALTER TABLE payment  CHANGE COLUMN adminfee_virtual  admin_fee_virtual DOUBLE  GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.adminFee', '&quot;',''), '[', ''),']', ''));
        </sql>
   </changeSet>

    <changeSet id="20180508111508-36" author="jhipster">
        <sql dbms="mysql">
            ALTER TABLE payment  CHANGE COLUMN remittanceadvice_virtual   remittance_advice_virtual DOUBLE  GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.remittanceAdvice', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment  CHANGE COLUMN buyerbsffee_virtual   buyer_bsf_fee_virtual DOUBLE  GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.buyerBusinessServiceFee', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment  CHANGE COLUMN buyerbsfgst_virtual   buyer_bsf_gst_virtual DOUBLE  GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.buyerBusinessServiceFeeGst', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment  CHANGE COLUMN supplierbsffee_virtual  supplier_bsf_fee_virtual DOUBLE  GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.supplierBusinessServiceFee', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment  CHANGE COLUMN supplierbSfgst_virtual  supplier_bsf_gst_virtual DOUBLE  GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.supplierBusinessServiceFeeGst', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment  CHANGE COLUMN buyerbsftotal_virtual   buyer_bsf_total_virtual DOUBLE  GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.buyerBsfTotal', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment  CHANGE COLUMN supplierbsftotal_virtual  supplier_bsf_total_virtual DOUBLE  GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.supplierBsfTotal', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment  CHANGE COLUMN earlypaymentdiscount_virtual  early_payment_discount_virtual DOUBLE  GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.earlyPaymentDiscount', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment  CHANGE COLUMN invoicegrandtotal_virtual   invoice_grand_total_virtual DOUBLE  GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.invoiceGrandTotal', '&quot;',''), '[', ''),']', ''));
            ALTER TABLE payment  CHANGE COLUMN totalamountpayable_virtual  total_amount_payable_virtual DOUBLE  GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.totalAmountPayable', '&quot;',''), '[', ''),']', ''));
        </sql>
    </changeSet>
    <changeSet author="jhipster" id="20180508111508-37">
        <addColumn
            tableName="payment">
            <column name="notify_on" type="date">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet author="jhipster" id="20180508111508-38">
        <addColumn tableName="payment">
            <column name="giro_file_name" type="varchar(255)"/>
            <column name="file_upload_ack" type="varchar(255)"/>
            <column name="file_access_ack" type="varchar(255)"/>
            <column name="transaction_ack" type="varchar(255)"/>
            <column name="transaction_status" type="varchar(255)"/>
        </addColumn>
    </changeSet>
    <changeSet author="jhipster" id="20180508111508-39">
        <addColumn
            tableName="payment">
            <column name="giro_modified_datetime" type="timestamp">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet author="jhipster" id="20190513111508-40">
        <addColumn
            tableName="payment">
            <column beforeColumn="file_upload_ack" afterColumn="giro_file_name" name="giro_file_seq_no" type="bigint">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="20190621111508-41" author="jhipster">
        <sql dbms="mysql">
            ALTER TABLE payment add tt_charge DOUBLE GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.ttCharge', '&quot;',''), '[', ''),']', ''));
        </sql>
    </changeSet>
    <changeSet id="20190621111508-42" author="jhipster">
        <dropColumn tableName="payment" columnName="invoice_virtual"/>
        <sql dbms="mysql">
            ALTER TABLE payment add invoice_virtual varchar(100) GENERATED ALWAYS AS (REPLACE(REPLACE(REPLACE(invoice_list->'$**.invoiceNumber', '&quot;',''), '[', ''),']', ''));
        </sql>
    </changeSet>

    <changeSet author="jhipster" failOnError="false" id="20190923161508-44">
        <addColumn
            tableName="payment">
            <column name="remarks" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

</databaseChangeLog>
